<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fitness Hub - Your Personal Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f8fafc; /* Tailwind gray-50 */
        }
        .nav-link {
            transition: color 0.2s, border-bottom-color 0.2s;
            border-bottom: 2px solid transparent;
        }
        .nav-link.active,
        .nav-link.active-home { /* <-- NEW STYLE FOR DASHBOARD */
            color: #4f46e5; /* Indigo-600 */
            border-bottom-color: #4f46e5;
        }
        .nav-link:hover {
            color: #4f46e5;
        }
        .nav-link-disabled {
            color: #9ca3af; /* gray-400 */
            cursor: not-allowed;
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        .card-hover {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        textarea { resize: none; }
        
        .set-input {
            width: 70px;
        }
        .exercise-list-item:hover {
            background-color: #f4f4f5;
        }

        /* === New styles for Exercises chip + list === */
        .exercise-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 10px;
            border-radius: 10px;
            border: 1px solid rgba(15, 23, 42, 0.04);
            transition: background-color 0.12s ease, transform 0.12s ease;
        }
        .exercise-row:hover {
            background-color: #fbfbfd;
            transform: translateY(-2px);
        }
        .exercise-meta {
            display: flex;
            flex-direction: column;
            gap: 2px;
            min-width: 0;
        }
        .exercise-name {
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .exercise-group {
            font-size: 12px;
            color: #6b7280; /* gray-500 */
        }
        .log-set-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid rgba(0,0,0,0.08);
            background: transparent;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            transition: transform 0.12s ease, background-color 0.12s ease, color 0.12s ease;
            color: #374151; /* gray-700 */
        }
        .log-set-chip:hover {
            transform: translateY(-2px);
            color: #4f46e5;
            border-color: rgba(79,70,229,0.18);
            background-color: rgba(79,70,229,0.04);
        }
        .log-set-chip .arrow {
            font-size: 14px;
            opacity: 0.9;
        }

        /* === Bottom sheet modal styles === */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(2,6,23,0.6);
            display: none;
            z-index: 60;
            -webkit-backdrop-filter: blur(4px);
            backdrop-filter: blur(4px);
        }
        .modal-backdrop.show {
            display: block;
        }
        .bottom-sheet {
            position: fixed;
            left: 0;
            right: 0;
            bottom: -100%;
            z-index: 70;
            background: white;
            border-top-left-radius: 16px;
            border-top-right-radius: 16px;
            box-shadow: 0 -10px 30px rgba(2,6,23,0.15);
            transition: transform 260ms cubic-bezier(.22,.9,.32,1), bottom 260ms;
            transform: translateY(0%);
            max-width: 900px;
            margin: 0 auto;
        }
        .bottom-sheet.show {
            transform: translateY(-100%);
            bottom: 0;
        }
        .sheet-handle {
            width: 48px;
            height: 5px;
            background: #e6e7ee;
            border-radius: 999px;
            margin: 10px auto;
        }
        .sheet-content {
            padding: 16px;
        }

        /* small-screen polish */
        @media (max-width: 640px) {
            .bottom-sheet {
                left: 0;
                right: 0;
                width: 100%;
                max-width: 100%;
            }
            .exercise-list {
                display: grid;
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }

        /* subtle focus states */
        .focus-ring:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(79,70,229,0.12);
            border-radius: 8px;
        }

    </style>
</head>
<body class="text-gray-800">

    <!-- NAV BAR (Unchanged) -->
    <nav class="bg-white shadow-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex-shrink-0">
                    <a href="#" id="home-logo" class="text-2xl font-extrabold text-indigo-600">FitnessHub</a>
                </div>
                <div id="main-nav" class="hidden md:block">
                    <div class="ml-10 flex items-baseline space-x-4">
                        <a href="#home" class="nav-link px-3 py-2 text-sm font-medium">Home</a>
                        <a href="#workout" class="nav-link px-3 py-2 text-sm font-medium">Workout Planner</a>
                        <a href="#diet" class="nav-link px-3 py-2 text-sm font-medium">Diet Planner</a>
                    </div>
                </div>
                <div id="auth-links" class="flex items-center">
                    </div>
            </div>
        </div>
    </nav>

    <main class="py-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">

            <!-- HOME PAGE (For logged-out users) -->
            <div id="page-home" class="page active">
                <header class="text-center mb-12">
                    <h1 class="text-4xl md:text-5xl font-extrabold text-gray-900 tracking-tight">Your Daily Fitness Briefing</h1>
                    <p class="mt-3 text-lg text-gray-600 max-w-3xl mx-auto">Latest insights and inspiration from the world of fitness, right here in the heartland.</p>
                </header>
                <div id="news-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    </div>
            </div>

            <!-- --- NEW DASHBOARD PAGE (For logged-in users) --- -->
            <div id="page-dashboard" class="page">
                <header class="text-center mb-12">
                    <h1 class="text-4xl md:text-5xl font-extrabold text-gray-900 tracking-tight">Welcome back, <span id="dash-username">User</span>!</h1>
                    <p class="mt-3 text-lg text-gray-600 max-w-3xl mx-auto">Here is your plan for today, <span id="dash-date"></span>.</p>
                </header>
                <div id="dashboard-content" class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Card 1: Today's Workout -->
                    <div class="bg-white p-6 rounded-xl shadow-lg border">
                        <h2 class="text-2xl font-bold mb-4">Today's Workout</h2>
                        <div id="dash-workout-summary" class="space-y-4">
                            <!-- JS will populate this -->
                        </div>
                    </div>
                    <!-- Card 2: Today's Diet -->
                    <div class="bg-white p-6 rounded-xl shadow-lg border">
                        <h2 class="text-2xl font-bold mb-4">Today's Diet</h2>
                        <div id="dash-diet-summary" class="space-y-4">
                             <div class="text-center">
                                <p class="text-lg text-gray-600">Total Calories</p>
                                <p id="dash-total-calories" class="text-5xl font-extrabold text-indigo-600">0</p>
                                <p class="text-gray-500">kcal</p>
                            </div>
                            <a href="#diet" class="nav-link-dash block w-full text-center bg-indigo-600 text-white font-semibold py-3 px-8 rounded-lg shadow-md hover:bg-indigo-700 transition-transform transform hover:scale-105">
                                Log Your Meals
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- WORKOUT PAGE (Updated Exercises UI + Bottom Sheet modal) -->
            <div id="page-workout" class="page">
                 <header class="text-center mb-10">
                    <h1 class="text-4xl md:text-5xl font-bold text-indigo-600">Daily Workout Log</h1>
                    <p class="mt-3 text-lg text-gray-600">Track your progress one set at a time.</p>
                </header>
                <div class="max-w-6xl mx-auto bg-white p-6 rounded-xl shadow-lg border mb-8">
                    <div class="flex items-center justify-between">
                        <label for="workout-date" class="font-semibold text-lg">Select Date:</label>
                        <input type="date" id="workout-date" class="border-gray-300 rounded-md shadow-sm text-lg p-2">
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg border">
                        <h2 class="text-2xl font-bold mb-4">Today's Log</h2>
                        <div id="workout-log-container" class="space-y-4"></div>
                        <p id="workout-log-empty" class="text-gray-500 hidden">No sets logged for this date. Add an exercise from your list to get started.</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg border self-start">
                        <h2 class="text-2xl font-bold mb-4">Your Exercises</h2>
                        <form id="add-exercise-form" class="mb-4 space-y-2 hidden">
                            <input type="text" id="new-exercise-name" placeholder="Exercise Name (e.g., Bench Press)" class="w-full px-3 py-2 border rounded-md" required>
                            <input type="text" id="new-exercise-group" placeholder="Muscle Group (e.g., Chest)" class="w-full px-3 py-2 border rounded-md" required>
                            <div class="flex gap-2">
                                <button type="submit" class="flex-1 bg-indigo-600 text-white py-2 rounded-md hover:bg-indigo-700 text-sm">Save</button>
                                <button type="button" id="cancel-add-exercise" class="flex-1 bg-gray-200 text-gray-700 py-2 rounded-md hover:bg-gray-300 text-sm">Cancel</button>
                            </div>
                        </form>
                        <button id="show-add-exercise-btn" class="w-full bg-green-500 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-green-600 transition mb-4">+ Add New Exercise</button>
                        <div id="exercise-list-container" class="space-y-2">
                            <p id="exercise-list-loading" class="text-gray-500">Loading exercises...</p>
                            <!-- Exercise list will be injected here as .exercise-list -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- DIET PAGE (Unchanged) -->
            <div id="page-diet" class="page">
                <header class="text-center mb-10">
                    <h1 class="text-4xl md:text-5xl font-bold text-indigo-600">Daily Diet Planner</h1>
                    <p class="mt-3 text-lg text-gray-600">Fuel your body right. Track your meals and calories.</p>
                </header>
                <div class="max-w-4xl mx-auto bg-white p-6 rounded-xl shadow-lg border">
                    <div class="flex items-center justify-between mb-6">
                        <label for="diet-date" class="font-semibold">Select Date:</label>
                        <input type="date" id="diet-date" class="border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div id="meals-container" class="space-y-6"></div>
                    <div class="mt-8 pt-4 border-t-2">
                        <h3 class="text-2xl font-bold text-right">Total Calories: <span id="total-calories" class="text-indigo-600">0</span></h3>
                    </div>
                </div>
                 <div class="mt-10 flex justify-center items-center gap-4">
                    <button id="save-diet-btn" class="bg-indigo-600 text-white font-semibold py-3 px-8 rounded-lg shadow-md hover:bg-indigo-700 transition-transform transform hover:scale-105">Save Diet Plan</button>
                </div>
            </div>
            
            <!-- AUTH PAGE (Unchanged) -->
            <div id="page-auth" class="page">
                <div class="max-w-md mx-auto mt-8">
                    <div class="bg-white p-8 rounded-xl shadow-lg border">
                        <div id="login-form-container">
                            <h2 class="text-2xl font-bold text-center mb-6">Login</h2>
                            <form id="login-form" class="space-y-4">
                                <input type="text" id="login-username" placeholder="Username" class="w-full px-4 py-2 border rounded-md" required>
                                <input type="password" id="login-password" placeholder="Password" class="w-full px-4 py-2 border rounded-md" required>
                                <button type="submit" class="w-full bg-indigo-600 text-white py-2 rounded-md hover:bg-indigo-700">Login</button>
                            </form>
                             <p class="text-center mt-4 text-sm">Don't have an account? <a href="#" id="show-register" class="text-indigo-600 hover:underline">Sign Up</a></p>
                        </div>
                        <div id="register-form-container" class="hidden">
                             <h2 class="text-2xl font-bold text-center mb-6">Sign Up</h2>
                            <form id="register-form" class="space-y-4">
                                <input type="text" id="register-username" placeholder="Username" class="w-full px-4 py-2 border rounded-md" required>
                                <input type="password" id="register-password" placeholder="Password" class="w-full px-4 py-2 border rounded-md" required>
                                <button type="submit" class="w-full bg-indigo-600 text-white py-2 rounded-md hover:bg-indigo-700">Create Account</button>
                            </form>
                             <p class="text-center mt-4 text-sm">Already have an account? <a href="#" id="show-login" class="text-indigo-600 hover:underline">Login</a></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Bottom Sheet Modal (NEW) -->
    <div id="modal-backdrop" class="modal-backdrop" aria-hidden="true"></div>

    <div id="bottom-sheet" class="bottom-sheet" role="dialog" aria-modal="true" aria-hidden="true">
        <div class="sheet-handle" id="sheet-handle" aria-hidden="true"></div>
        <div class="sheet-content">
            <div class="flex items-start justify-between">
                <div>
                    <h3 id="sheet-exercise-name" class="text-lg font-semibold">Exercise</h3>
                    <p id="sheet-exercise-group" class="text-sm text-gray-500">Muscle Group</p>
                </div>
                <button id="sheet-close-btn" class="text-gray-600 hover:text-gray-800" aria-label="Close modal">✕</button>
            </div>

            <form id="sheet-log-form" class="mt-4 space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <label class="flex flex-col">
                        <span class="text-sm text-gray-600">Reps</span>
                        <input id="sheet-reps" type="number" min="1" class="border rounded-md px-3 py-2 focus-ring" placeholder="e.g., 5" required>
                    </label>
                    <label class="flex flex-col">
                        <span class="text-sm text-gray-600">Weight</span>
                        <input id="sheet-weight" type="number" min="0" step="0.1" class="border rounded-md px-3 py-2 focus-ring" placeholder="e.g., 185" required>
                    </label>
                </div>
                <div class="flex items-center gap-3">
                    <button id="sheet-add-btn" type="submit" class="flex-1 bg-indigo-600 text-white py-3 rounded-md font-semibold hover:bg-indigo-700">Add Set</button>
                    <button id="sheet-cancel-btn" type="button" class="flex-1 bg-gray-100 text-gray-700 py-3 rounded-md hover:bg-gray-200">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- TOAST (Unchanged) -->
    <div id="toast-message" class="fixed bottom-10 right-10 bg-green-500 text-white py-3 px-6 rounded-lg shadow-xl opacity-0 translate-y-4 transition-all duration-300"></div>

    <script>
        // --- SCRIPT START ---
        document.addEventListener('DOMContentLoaded', () => {

            // --- API Configuration (Unchanged) ---
            const API_URL = 'http://127.0.0.1:8000/api';

            // --- STATE MANAGEMENT (Unchanged) ---
            const appState = {
                currentUser: null,
                authToken: null, 
                currentPage: '#home',
                currentDietLogId: null,
                userExercises: [], 
                todaysWorkoutSets: [],
            };

            // --- DOM ELEMENTS (Unchanged) ---
            const pages = document.querySelectorAll('.page');
            const navLinks = document.querySelectorAll('.nav-link');
            const workoutNavLink = document.querySelector('.nav-link[href="#workout"]');
            const dietNavLink = document.querySelector('.nav-link[href="#diet"]');
            const authLinksContainer = document.getElementById('auth-links');
            const mainNav = document.getElementById('main-nav');
            const toastMessage = document.getElementById('toast-message');
            const mealsContainer = document.getElementById('meals-container');

            // Bottom sheet elements (new)
            const modalBackdrop = document.getElementById('modal-backdrop');
            const bottomSheet = document.getElementById('bottom-sheet');
            const sheetExerciseName = document.getElementById('sheet-exercise-name');
            const sheetExerciseGroup = document.getElementById('sheet-exercise-group');
            const sheetReps = document.getElementById('sheet-reps');
            const sheetWeight = document.getElementById('sheet-weight');
            const sheetAddBtn = document.getElementById('sheet-add-btn');
            const sheetCancelBtn = document.getElementById('sheet-cancel-btn');
            const sheetCloseBtn = document.getElementById('sheet-close-btn');
            const sheetHandle = document.getElementById('sheet-handle');

            // Track which exercise is currently active in sheet
            let activeSheetExercise = { id: null, name: '', group: '' };

            // --- MOCK DATA (Unchanged) ---
            const newsData = [
                { title: "The Science of Rest Days: Why They're More Important Than You Think", source: "Fitness Today", date: "Oct 28, 2025", summary: "New studies from the University of Nebraska show that structured rest days can increase muscle protein synthesis by up to 50%.", image: "https://placehold.co/600x400/a5b4fc/1e1b4b?text=Rest+Science" },
                { title: "Kettlebell vs. Dumbbell: Which is Right for Your Home Gym?", source: "Iron & Grit", date: "Oct 27, 2025", summary: "We break down the functional differences, from swing dynamics to progressive overload, helping you make the smartest investment.", image: "https://placehold.co/600x400/fca5a5/450a0a?text=Kettlebell" },
                { title: "Top 5 High-Protein Breakfasts to Fuel Your Morning Workout", source: "Nutrition Weekly", date: "Oct 26, 2025", summary: "Forget sugary cereals. Dietitians share their go-to recipes that pack over 30g of protein to keep you full and energized.", image: "https://placehold.co/600x400/a7f3d0/064e3b?text=Healthy+Breakfast" },
            ];

            // --- API Helper Function (Unchanged) ---
            async function fetchApi(endpoint, options = {}) {
                const headers = {
                    'Content-Type': 'application/json',
                    ...options.headers,
                };
                if (appState.authToken) {
                    headers['Authorization'] = `Token ${appState.authToken}`;
                }
                try {
                    const response = await fetch(`${API_URL}${endpoint}`, {
                        ...options,
                        headers: headers,
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error('API Error:', errorData);
                        throw new Error(`API request failed: ${response.statusText}`);
                    }
                    if (response.status === 204) { return null; }
                    return response.json();
                } catch (error) {
                    console.error('Network Error:', error);
                    showToast('An error occurred. Please try again.');
                    throw error;
                }
            }

            // --- ROUTING / PAGE NAVIGATION (Unchanged) ---
            const navigateTo = (hash) => {
                const isLoggedIn = !!appState.currentUser;
                
                if (isLoggedIn && hash === '#home') {
                    hash = '#dashboard';
                }
                
                if (!isLoggedIn && (hash === '#workout' || hash === '#diet')) {
                    hash = '#auth';
                }
                if (isLoggedIn && hash === '#auth') {
                    hash = '#home'; 
                }
                
                appState.currentPage = hash;
                
                pages.forEach(p => p.classList.remove('active'));
                const activePage = document.getElementById(`page-${hash.slice(1)}`);
                if (activePage) {
                    activePage.classList.add('active');
                } else {
                    document.getElementById(isLoggedIn ? 'page-dashboard' : 'page-home').classList.add('active');
                }
                
                navLinks.forEach(l => l.classList.remove('active', 'active-home'));
                let activeLink = document.querySelector(`.nav-link[href="${hash}"]`);
                if (hash === '#dashboard') {
                    activeLink = document.querySelector(`.nav-link[href="#home"]`);
                    if(activeLink) activeLink.classList.add('active-home');
                } else if (activeLink) {
                    activeLink.classList.add('active');
                }

                window.location.hash = hash;
                updateUI();
            };

            // --- UI UPDATES (Unchanged) ---
            const updateUI = () => {
                if (appState.currentUser) {
                    mainNav.classList.remove('hidden');
                    workoutNavLink.classList.remove('nav-link-disabled');
                    dietNavLink.classList.remove('nav-link-disabled');
                    workoutNavLink.removeAttribute('title');
                    dietNavLink.removeAttribute('title');
                    workoutNavLink.style.pointerEvents = 'auto';
                    dietNavLink.style.pointerEvents = 'auto';

                    authLinksContainer.innerHTML = `
                        <span class="mr-4 text-gray-600">Welcome, <strong>${appState.currentUser}</strong></span>
                        <button id="logout-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300 transition text-sm font-medium">Logout</button>
                    `;
                    document.getElementById('logout-btn').addEventListener('click', handleLogout);
                } else {
                    mainNav.classList.remove('hidden');
                    workoutNavLink.classList.add('nav-link-disabled');
                    dietNavLink.classList.add('nav-link-disabled');
                    const loginTooltip = 'Please log in to access';
                    workoutNavLink.setAttribute('title', loginTooltip);
                    dietNavLink.setAttribute('title', loginTooltip);
                    workoutNavLink.style.pointerEvents = 'none';
                    dietNavLink.style.pointerEvents = 'none';

                    authLinksContainer.innerHTML = `
                        <a href="#auth" id="nav-auth-login" class="text-gray-600 mr-4 hover:text-indigo-600">Login</a>
                        <a href="#auth" id="nav-auth-signup" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 transition">Sign Up</a>
                    `;
                    
                    document.getElementById('nav-auth-login').addEventListener('click', (e) => {
                        e.preventDefault();
                        navigateTo('#auth');
                        document.getElementById('register-form-container').classList.add('hidden');
                        document.getElementById('login-form-container').classList.remove('hidden');
                    });
                    
                    document.getElementById('nav-auth-signup').addEventListener('click', (e) => {
                        e.preventDefault();
                        navigateTo('#auth');
                        document.getElementById('login-form-container').classList.add('hidden');
                        document.getElementById('register-form-container').classList.remove('hidden');
                    });
                }
                
                if (appState.currentPage === '#dashboard') initDashboard();
                if (appState.currentPage === '#workout') initWorkoutPlanner();
                if (appState.currentPage === '#diet') initDietPlanner();
            };
            
            const showToast = (message) => {
                toastMessage.textContent = message;
                toastMessage.classList.remove('opacity-0', 'translate-y-4');
                setTimeout(() => {
                    toastMessage.classList.add('opacity-0', 'translate-y-4');
                }, 2500);
            };

            // --- AUTHENTICATION LOGIC (Unchanged) ---
            const handleLogin = async (e) => {
                e.preventDefault();
                const username = document.getElementById('login-username').value;
                const password = document.getElementById('login-password').value;
                try {
                    const data = await fetchApi('/token/', {
                        method: 'POST',
                        body: JSON.stringify({ username, password })
                    });
                    if (data.token) {
                        appState.currentUser = username;
                        appState.authToken = data.token;
                        localStorage.setItem('fitnessCurrentUser', username);
                        localStorage.setItem('fitnessAuthToken', data.token);
                        navigateTo('#home'); 
                    } else {
                        alert('Login failed. Please check your credentials.');
                    }
                } catch (error) {
                    alert('Login failed. Please check your credentials.');
                }
            };
            
            const handleRegister = async (e) => {
                e.preventDefault();
                const username = document.getElementById('register-username').value;
                const password = document.getElementById('register-password').value;
                try {
                    await fetchApi('/register/', {
                        method: 'POST',
                        body: JSON.stringify({ username, password })
                    });
                    const tokenData = await fetchApi('/token/', {
                        method: 'POST',
                        body: JSON.stringify({ username, password })
                    });
                    if (tokenData.token) {
                        localStorage.setItem('fitnessCurrentUser', username);
                        localStorage.setItem('fitnessAuthToken', tokenData.token);
                        window.location.hash = '#home'; 
                        window.location.reload();
                    } else {
                        alert('Account created, but auto-login failed. Please log in manually.');
                        navigateTo('#auth');
                    }
                } catch (error) {
                    alert('Registration failed. Username might already exist.');
                }
            };

            const handleLogout = () => {
                appState.currentUser = null;
                appState.authToken = null;
                localStorage.removeItem('fitnessCurrentUser');
                localStorage.removeItem('fitnessAuthToken');
                window.location.hash = '#home'; 
                window.location.reload();
            };

            const checkInitialAuth = () => {
                const user = localStorage.getItem('fitnessCurrentUser');
                const token = localStorage.getItem('fitnessAuthToken');
                if (user && token) {
                    appState.currentUser = user;
                    appState.authToken = token;
                }
            };

            // --- HOME PAGE LOGIC (Unchanged) ---
            const initHomePage = () => {
                const newsGrid = document.getElementById('news-grid');
                if (newsGrid.innerHTML) return; 
                newsGrid.innerHTML = newsData.map(article => `
                    <div class="card-hover bg-white rounded-xl shadow-lg overflow-hidden border border-gray-200">
                        <img src="${article.image}" alt="${article.title}" class="w-full h-48 object-cover">
                        <div class="p-6">
                            <p class="text-sm text-indigo-600 font-semibold">${article.source} - ${article.date}</p>
                            <h2 class="text-xl font-bold text-gray-900 mt-1">${article.title}</h2>
                            <p class="text-gray-600 mt-2">${article.summary}</p>
                        </div>
                    </div>
                `).join('');
            };

            // --- DASHBOARD LOGIC (MODIFIED) ---
            const initDashboard = async () => {
                if (!appState.currentUser) return;

                document.getElementById('dash-username').textContent = appState.currentUser;
                document.getElementById('dash-date').textContent = new Date().toLocaleDateString(undefined, {
                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
                });
                
                const workoutContainer = document.getElementById('dash-workout-summary');
                const dietContainer = document.getElementById('dash-total-calories');
                workoutContainer.innerHTML = '<p class="text-gray-500">Loading summary...</p>';
                dietContainer.textContent = '...';

                try {
                    const data = await fetchApi('/dashboard/');
                    
                    // 1. Render Workout Summary
                    const workoutSummary = data.workout_summary;
                    if (workoutSummary.length === 0) {
                        workoutContainer.innerHTML = `
                            <p class="text-gray-500 mb-4">You haven't logged any sets today.</p>
                            <a href="#workout" class="nav-link-dash block w-full text-center bg-indigo-600 text-white font-semibold py-3 px-8 rounded-lg shadow-md hover:bg-indigo-700 transition-transform transform hover:scale-105">
                                Log Your Workout
                            </a>
                        `;
                    } else {
                        const setsByExercise = workoutSummary.reduce((acc, set) => {
                            const exName = set.exercise_name || 'Exercise';
                            if (!acc[exName]) acc[exName] = 0;
                            acc[exName]++;
                            return acc;
                        }, {});

                        workoutContainer.innerHTML = `
                            <ul class="space-y-2 mb-4">
                            ${Object.entries(setsByExercise).map(([name, count]) => `
                                <li class="flex justify-between items-center bg-gray-100 p-3 rounded-md">
                                    <span class="font-semibold">${name}</span>
                                    <span class="text-gray-600">${count} set${count > 1 ? 's' : ''} logged</span>
                                </li>
                            `).join('')}
                            </ul>
                            <a href="#workout" class="nav-link-dash block w-full text-center bg-gray-200 text-gray-700 font-semibold py-3 px-8 rounded-lg shadow-md hover:bg-gray-300 transition">
                                View Full Workout
                            </a>
                        `;
                    }

                    // 2. Render Diet Summary
                    dietContainer.textContent = data.diet_summary.total_calories || 0;

                    // --- THIS IS THE FIX ---
                    document.querySelectorAll('.nav-link-dash').forEach(link => {
                        link.addEventListener('click', (e) => {
                            e.preventDefault();
                            const targetHash = e.currentTarget.hash;
                            if (targetHash) {
                                navigateTo(targetHash);
                            }
                        });
                    });
                    // --- END FIX ---

                } catch (error) {
                    workoutContainer.innerHTML = '<p class="text-red-500">Could not load workout summary.</p>';
                    dietContainer.textContent = 'Error';
                }
            };

            // --- WORKOUT PLANNER LOGIC (Updated with new exercise UI + sheet) ---
            const initWorkoutPlanner = () => {
                const workoutDateInput = document.getElementById('workout-date');
                if (workoutDateInput.value) return; 

                workoutDateInput.valueAsDate = new Date();
                
                workoutDateInput.addEventListener('change', loadWorkoutSets);
                document.getElementById('show-add-exercise-btn').addEventListener('click', () => {
                    document.getElementById('add-exercise-form').classList.remove('hidden');
                    document.getElementById('show-add-exercise-btn').classList.add('hidden');
                });
                document.getElementById('cancel-add-exercise').addEventListener('click', () => {
                    document.getElementById('add-exercise-form').classList.add('hidden');
                    document.getElementById('show-add-exercise-btn').classList.remove('hidden');
                });
                document.getElementById('add-exercise-form').addEventListener('submit', handleCreateExercise);

                const exerciseListContainer = document.getElementById('exercise-list-container');
                // updated click handler: opens bottom sheet when chip clicked
                exerciseListContainer.addEventListener('click', handleExerciseListClick);
                
                const workoutLogContainer = document.getElementById('workout-log-container');
                workoutLogContainer.addEventListener('click', handleDeleteSet);
                
                loadUserExercises();
                loadWorkoutSets();

                // bottom sheet events
                modalBackdrop.addEventListener('click', closeBottomSheet);
                sheetCloseBtn.addEventListener('click', closeBottomSheet);
                sheetCancelBtn.addEventListener('click', closeBottomSheet);
                document.getElementById('sheet-log-form').addEventListener('submit', handleSheetSubmit);

                // drag-to-close support (touch + mouse)
                setupSheetDrag();
            };

            const loadUserExercises = async () => {
                const container = document.getElementById('exercise-list-container');
                const loadingMsg = document.getElementById('exercise-list-loading');
                try {
                    const exercises = await fetchApi('/exercises/');
                    appState.userExercises = exercises;
                    
                    if (exercises.length === 0) {
                        loadingMsg.textContent = 'No exercises found. Add one!';
                        container.innerHTML = '';
                        container.appendChild(loadingMsg);
                        return;
                    }
                    
                    if(loadingMsg) loadingMsg.remove();
                    // create an exercises wrapper
                    const listHtml = `<div class="exercise-list">${exercises.map(ex => renderExerciseItem(ex)).join('')}</div>`;
                    container.innerHTML = listHtml;

                } catch (error) {
                    container.innerHTML = '<p class="text-red-500 text-sm">Could not load exercises.</p>';
                }
            };

            // Updated renderer for exercise list items (Option B1 with subtle outline chip)
            const renderExerciseItem = (ex) => {
                // using data attributes for id/name/group
                return `
                <div class="exercise-row" data-exercise-id="${ex.id}" aria-label="Exercise ${escapeHtml(ex.name)}">
                    <div class="exercise-meta">
                        <div class="exercise-name">${escapeHtml(ex.name)}</div>
                        <div class="exercise-group">${escapeHtml(ex.muscle_group || '')}</div>
                    </div>
                    <button class="log-set-chip focus-ring" data-exercise-id="${ex.id}" data-exercise-name="${escapeHtml(ex.name)}" data-exercise-group="${escapeHtml(ex.muscle_group || '')}" aria-haspopup="dialog">
                        Log Set <span class="arrow">›</span>
                    </button>
                </div>
                `;
            };
            
            // click behavior for exercise list (opens sheet)
            const handleExerciseListClick = (e) => {
                const chip = e.target.closest('.log-set-chip');
                if (chip) {
                    const exId = chip.dataset.exerciseId;
                    const exName = chip.dataset.exerciseName;
                    const exGroup = chip.dataset.exerciseGroup;
                    openBottomSheet({ id: exId, name: exName, group: exGroup });
                }
            };

            const handleCreateExercise = async (e) => {
                e.preventDefault();
                const nameInput = document.getElementById('new-exercise-name');
                const groupInput = document.getElementById('new-exercise-group');
                
                const name = nameInput.value;
                const group = groupInput.value;
                
                if (!name || !group) return;

                try {
                    const newExercise = await fetchApi('/exercises/', {
                        method: 'POST',
                        body: JSON.stringify({ name: name, muscle_group: group })
                    });
                    
                    nameInput.value = '';
                    groupInput.value = '';
                    document.getElementById('add-exercise-form').classList.add('hidden');
                    document.getElementById('show-add-exercise-btn').classList.remove('hidden');
                    
                    showToast('Exercise created!');
                    
                    // append new exercise to list
                    const container = document.querySelector('#exercise-list-container .exercise-list');
                    if (container) {
                        container.insertAdjacentHTML('beforeend', renderExerciseItem(newExercise));
                    } else {
                        // reload if container missing
                        await loadUserExercises();
                    }
                    
                    appState.userExercises.push(newExercise);

                } catch (error) {
                    showToast('Failed to create exercise.');
                }
            };

            // New helper for adding a set through API (used by modal)
            const addSetViaApi = async (exerciseId, reps, weight) => {
                const date = document.getElementById('workout-date').value || new Date().toISOString().slice(0,10);
                const body = {
                    exercise: exerciseId,
                    date: date,
                    reps: parseInt(reps, 10),
                    weight: parseFloat(weight)
                };
                const newSet = await fetchApi('/sets/', {
                    method: 'POST',
                    body: JSON.stringify(body)
                });
                return newSet;
            };

            // old handleAddSet function is kept for forms if still present elsewhere;
            // but main flow now uses addSetViaApi called from modal.
            const handleAddSet = async (formElement) => {
                // legacy inline-add support (if you ever show inline form)
                const exerciseId = formElement.dataset.exerciseId;
                const reps = formElement.querySelector('.reps-input').value;
                const weight = formElement.querySelector('.weight-input').value;
                if (!reps || !weight) {
                    alert('Please enter both reps and weight.');
                    return;
                }
                try {
                    const newSet = await addSetViaApi(exerciseId, reps, weight);
                    formElement.querySelector('.reps-input').value = '';
                    formElement.querySelector('.weight-input').value = '';
                    formElement.classList.add('hidden');
                    showToast('Set added!');
                    addSetToLog(newSet);
                } catch (error) {
                    showToast('Failed to add set.');
                }
            };

            const loadWorkoutSets = async () => {
                const container = document.getElementById('workout-log-container');
                const emptyMsg = document.getElementById('workout-log-empty');
                const date = document.getElementById('workout-date').value;
                
                container.innerHTML = '';
                emptyMsg.classList.add('hidden');
                
                try {
                    const sets = await fetchApi(`/sets/?date=${date}`);
                    appState.todaysWorkoutSets = sets;
                    
                    if (sets.length === 0) {
                        emptyMsg.classList.remove('hidden');
                        return;
                    }
                    
                    const setsByExercise = sets.reduce((acc, set) => {
                        const exName = set.exercise_name || 'Exercise';
                        if (!acc[exName]) acc[exName] = [];
                        acc[exName].push(set);
                        return acc;
                    }, {});

                    container.innerHTML = Object.entries(setsByExercise).map(([exerciseName, sets]) => {
                        const setsHtml = sets.map(set => renderSetItem(set)).join('');
                        return `
                            <div class="space-y-2" data-log-exercise-name="${exerciseName}">
                                <h3 class="text-lg font-semibold">${exerciseName}</h3>
                                <ul class="space-y-2">${setsHtml}</ul>
                            </div>
                        `;
                    }).join('');
                    
                } catch (error) {
                    console.error('Error loading workout sets:', error);
                    emptyMsg.classList.remove('hidden');
                }
            };
            
            const renderSetItem = (set) => {
                return `
                <li class="flex justify-between items-center bg-gray-100 p-2 rounded-md" data-set-id="${set.id}">
                    <span><strong>${set.reps}</strong> reps at <strong>${set.weight}</strong> lbs/kg</span>
                    <button class="delete-set-btn text-red-500 font-bold text-lg">✕</button>
                </li>
                `;
            };

            const addSetToLog = (set) => {
                const container = document.getElementById('workout-log-container');
                const emptyMsg = document.getElementById('workout-log-empty');
                emptyMsg.classList.add('hidden');

                const setHtml = renderSetItem(set);
                const exName = set.exercise_name || 'Exercise';

                let exerciseGroup = container.querySelector(`div[data-log-exercise-name="${exName}"] ul`);
                
                if (exerciseGroup) {
                    exerciseGroup.insertAdjacentHTML('beforeend', setHtml);
                } else {
                    const newGroupHtml = `
                    <div class="space-y-2" data-log-exercise-name="${exName}">
                        <h3 class="text-lg font-semibold">${exName}</h3>
                        <ul class="space-y-2">${setHtml}</ul>
                    </div>
                    `;
                    container.insertAdjacentHTML('beforeend', newGroupHtml);
                }
            };

            const handleDeleteSet = async (e) => {
                if (!e.target.classList.contains('delete-set-btn')) return;
                
                const setItem = e.target.closest('li');
                const setId = setItem.dataset.setId;
                
                if (!setId || !confirm('Delete this set?')) return;
                
                try {
                    await fetchApi(`/sets/${setId}/`, {
                        method: 'DELETE'
                    });
                    
                    const list = setItem.closest('ul');
                    setItem.remove();
                    
                    if (list.children.length === 0) {
                        list.closest('div').remove();
                    }
                    
                    if (document.getElementById('workout-log-container').children.length === 0) {
                        document.getElementById('workout-log-empty').classList.remove('hidden');
                    }
                    
                    showToast('Set deleted.');
                } catch (error) {
                    showToast('Failed to delete set.');
                }
            };

            // --- DIET PLANNER LOGIC (Unchanged) ---
            const initDietPlanner = async () => {
                const dateInput = document.getElementById('diet-date');
                if (dateInput.value) return; 

                dateInput.valueAsDate = new Date(); 
                renderDietMeals();
                await loadDietPlan();

                const mealsContainerElement = document.getElementById('meals-container');
                mealsContainerElement.removeEventListener('click', handleMealContainerClick);
                mealsContainerElement.addEventListener('click', handleMealContainerClick);

                dateInput.removeEventListener('change', loadDietPlan);
                dateInput.addEventListener('change', loadDietPlan);
            };

            const renderDietMeals = () => {
                 const mealsContainerElement = document.getElementById('meals-container');
                if (mealsContainerElement.innerHTML !== '') return;
                
                const mealTypes = ['Breakfast', 'Lunch', 'Dinner', 'Snacks'];
                mealsContainerElement.innerHTML = mealTypes.map(meal => `
                    <div class="meal-section" data-meal="${meal}">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="text-xl font-semibold">${meal}</h4>
                            <button class="add-food-btn text-indigo-600 hover:text-indigo-800 text-sm font-bold">+ Add Food</button>
                        </div>
                        <ul class="food-list space-y-2"></ul>
                        <p class="text-right mt-2 font-medium">Meal Total: <span class="meal-calories-total text-gray-700">0</span> kcal</p>
                    </div>
                `).join(''); 
            };
            
            const addFoodToMeal = (meal, name, calories, foodId = null) => {
                const mealSection = document.querySelector(`.meal-section[data-meal="${meal}"]`);
                if (!mealSection) return;
                const foodList = mealSection.querySelector('.food-list');
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center bg-gray-100 p-2 rounded-md';
                if (foodId) {
                    li.dataset.foodId = foodId;
                }
                li.innerHTML = `
                    <span>${name}</span>
                    <div>
                        <span class="font-semibold" data-calories="${calories}">${calories} kcal</span>
                        <button class="remove-food-btn text-red-500 ml-4 font-bold">✕</button>
                    </div>
                `;
                foodList.appendChild(li);
                updateAllCalories();
            };
            
            const handleMealContainerClick = async (e) => {
                if (e.target.classList.contains('add-food-btn')) {
                    const meal = e.target.closest('.meal-section').dataset.meal;
                    const foodName = prompt("Enter food name:");
                    if (!foodName) return;
                    const caloriesText = prompt("Enter calories:");
                    if (caloriesText === null) return;
                    const calories = parseInt(caloriesText, 10);
                    
                    if (!isNaN(calories) && calories >= 0) {
                        try {
                            // --- THIS IS THE FIX ---
                            // Step 1: Ensure a DietLog exists for this day
                            if (!appState.currentDietLogId) {
                                const date = document.getElementById('diet-date').value;
                                // We check if a log exists first, or create one
                                const logs = await fetchApi(`/dietlogs/?date=${date}`);
                                if (logs.length > 0) {
                                    appState.currentDietLogId = logs[0].id;
                                } else {
                                    const newLog = await fetchApi('/dietlogs/', {
                                        method: 'POST',
                                        body: JSON.stringify({ date: date })
                                    });
                                    appState.currentDietLogId = newLog.id;
                                }
                            }
                            
                            // Step 2: Add the food item *with* the diet_log_id
                            const newFoodItem = await fetchApi('/fooditems/', {
                                method: 'POST',
                                body: JSON.stringify({
                                    name: foodName,
                                    calories: calories,
                                    meal_type: meal,
                                    diet_log_id: appState.currentDietLogId // This is now guaranteed to be set
                                })
                            });
                            
                            addFoodToMeal(meal, foodName, calories, newFoodItem.id);

                        } catch (error) {
                            showToast('Failed to add food item.');
                        }
                    } else {
                        alert("Please enter a valid non-negative number for calories.");
                    }
                }
                
                if (e.target.classList.contains('remove-food-btn')) {
                    const li = e.target.closest('li');
                    const foodId = li.dataset.foodId;
                    if (!foodId) return;

                    try {
                        await fetchApi(`/fooditems/${foodId}/`, {
                            method: 'DELETE'
                        });
                        li.remove();
                        updateAllCalories();
                    } catch (error) {
                        showToast('Failed to remove food item.');
                    }
                }
            };

            const updateAllCalories = () => {
                let grandTotal = 0;
                document.querySelectorAll('.meal-section').forEach(section => {
                    let mealTotal = 0;
                    section.querySelectorAll('.food-list [data-calories]').forEach(item => {
                        mealTotal += parseInt(item.dataset.calories, 10);
                    });
                    const mealTotalElement = section.querySelector('.meal-calories-total');
                    if (mealTotalElement) mealTotalElement.textContent = mealTotal;
                    grandTotal += mealTotal;
                });
                const totalCaloriesElement = document.getElementById('total-calories');
                if (totalCaloriesElement) totalCaloriesElement.textContent = grandTotal;
            };
            
            const saveDietPlan = () => {
                showToast('Diet plan saved successfully!');
            };
            
            const loadDietPlan = async () => {
                if (!appState.currentUser) return;
                const date = document.getElementById('diet-date').value;
                document.querySelectorAll('.food-list').forEach(list => list.innerHTML = '');
                appState.currentDietLogId = null;

                try {
                    const dietLogs = await fetchApi(`/dietlogs/?date=${date}`);
                    
                    if (dietLogs.length > 0) {
                        const dietData = dietLogs[0];
                        appState.currentDietLogId = dietData.id;
                        
                        dietData.food_items.forEach(food => {
                            addFoodToMeal(food.meal_type, food.name, food.calories, food.id);
                        });
                    } else {
                        updateAllCalories();
                    }
                } catch (error) {
                    showToast('Failed to load diet plan.');
                }
            };

            // --- Bottom sheet modal helpers (NEW) ---

            function openBottomSheet(exercise) {
                activeSheetExercise = exercise;
                sheetExerciseName.textContent = exercise.name || 'Exercise';
                sheetExerciseGroup.textContent = exercise.group || '';
                sheetReps.value = '';
                sheetWeight.value = '';
                bottomSheet.classList.add('show');
                bottomSheet.setAttribute('aria-hidden', 'false');
                modalBackdrop.classList.add('show');
                modalBackdrop.setAttribute('aria-hidden', 'false');
                // prevent page scrolling when sheet is open
                document.documentElement.style.overflow = 'hidden';
                // focus the reps input after a short delay
                setTimeout(() => sheetReps.focus(), 200);
            }

            function closeBottomSheet() {
                bottomSheet.classList.remove('show');
                bottomSheet.setAttribute('aria-hidden', 'true');
                modalBackdrop.classList.remove('show');
                modalBackdrop.setAttribute('aria-hidden', 'true');
                document.documentElement.style.overflow = '';
            }

            async function handleSheetSubmit(e) {
                e.preventDefault();
                const reps = sheetReps.value;
                const weight = sheetWeight.value;
                if (!reps || !weight) {
                    alert('Please enter reps and weight.');
                    return;
                }
                try {
                    const newSet = await addSetViaApi(activeSheetExercise.id, reps, weight);
                    // Add to UI
                    addSetToLog(newSet);
                    showToast('Set added!');
                    // close sheet (Option C1 behavior)
                    closeBottomSheet();
                } catch (err) {
                    showToast('Failed to add set.');
                }
            }

            // Drag-to-close implementation (touch + mouse)
            function setupSheetDrag() {
                let startY = 0;
                let currentY = 0;
                let dragging = false;

                const onStart = (clientY) => {
                    startY = clientY;
                    currentY = startY;
                    dragging = true;
                    bottomSheet.style.transition = 'none';
                };
                const onMove = (clientY) => {
                    if (!dragging) return;
                    currentY = clientY;
                    const delta = Math.max(0, currentY - startY); // only downward
                    bottomSheet.style.transform = `translateY(${delta}px)`;
                };
                const onEnd = () => {
                    if (!dragging) return;
                    const delta = currentY - startY;
                    bottomSheet.style.transition = '';
                    bottomSheet.style.transform = '';
                    dragging = false;
                    // if dragged more than 120px, close
                    if (delta > 120) {
                        closeBottomSheet();
                    }
                };

                // touch events
                sheetHandle.addEventListener('touchstart', (ev) => onStart(ev.touches[0].clientY), { passive: true });
                sheetHandle.addEventListener('touchmove', (ev) => onMove(ev.touches[0].clientY), { passive: true });
                sheetHandle.addEventListener('touchend', onEnd);

                // mouse events for desktop
                let mouseDown = false;
                sheetHandle.addEventListener('mousedown', (ev) => {
                    mouseDown = true;
                    onStart(ev.clientY);
                    document.body.style.userSelect = 'none';
                });
                window.addEventListener('mousemove', (ev) => {
                    if (!mouseDown) return;
                    onMove(ev.clientY);
                });
                window.addEventListener('mouseup', (ev) => {
                    if (!mouseDown) return;
                    mouseDown = false;
                    onEnd();
                    document.body.style.userSelect = '';
                });
            }

            // --- INITIALIZATION (Unchanged but with updated event bindings) ---
            function initializeApp() {
                checkInitialAuth();
                initHomePage();
                
                document.querySelectorAll('.nav-link, #home-logo').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const targetHash = e.currentTarget.hash || '#home';
                        navigateTo(targetHash);
                    });
                });

                document.getElementById('show-register').addEventListener('click', (e) => {
                    e.preventDefault();
                    document.getElementById('login-form-container').classList.add('hidden');
                    document.getElementById('register-form-container').classList.remove('hidden');
                });
                 document.getElementById('show-login').addEventListener('click', (e) => {
                    e.preventDefault();
                    document.getElementById('register-form-container').classList.add('hidden');
                    document.getElementById('login-form-container').classList.remove('hidden');
                });
                
                document.getElementById('login-form').addEventListener('submit', handleLogin);
                document.getElementById('register-form').addEventListener('submit', handleRegister);
                
                document.getElementById('save-diet-btn').addEventListener('click', saveDietPlan);

                const initialHash = window.location.hash || '#home';
                navigateTo(initialHash);
            }

            initializeApp();

            // --- small helpers ---
            function escapeHtml(unsafe) {
                if (!unsafe && unsafe !== 0) return '';
                return String(unsafe)
                  .replace(/&/g, "&amp;")
                  .replace(/</g, "&lt;")
                  .replace(/>/g, "&gt;")
                  .replace(/"/g, "&quot;")
                  .replace(/'/g, "&#039;");
            }

        });
    </script>
</body>
</html>
